<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Quản Lý Công Văn</title>
    <base href="/quan-ly-cong-van/"> <!-- THÊM DÒNG NÀY -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Thêm Firebase SDK -->
    <!-- Firebase App (the core Firebase SDK) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<!-- Firebase Authentication -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<!-- Firebase Realtime Database -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        /* CSS giữ nguyên như trước */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1e4c78 0%, #2c6cb0 100%);
            color: #333;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            zoom: 0.75;
        }
        
        /* Container cho màn hình đăng nhập/đăng ký */
        .login-container {
            width: 100%;
            max-width: 500px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            padding: 40px;
        }

        /* Container cho giao diện chính của ứng dụng */
        .main-layout {
            display: none; /* Ban đầu ẩn */
            width: 100%;
            min-height: 100vh;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .sidebar {
            position: fixed; /* Giữ sidebar cố định trên màn hình */
            top: 0;          /* Đặt sidebar ở phía trên cùng của màn hình */
            bottom: 0;       /* Đặt sidebar ở phía dưới cùng của màn hình */
            width: 250px;
            background-color: #f4f4f4;
            padding: 20px;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .logo {
            text-align: center;
            margin-bottom: 20px;
            color: #1e4c78;
        }

        .logo h2 {
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .logo p {
            font-size: 14px;
            color: #666;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            cursor: pointer;
            font-size: 16px;
            color: #555;
            border-radius: 5px;
            transition: background-color 0.3s, color 0.3s;
        }

        .menu-item:hover, .menu-item.active {
            background-color: #1e4c78;
            color: white;
        }

        .menu-item i {
            font-size: 20px;
        }

        .content-container {
            margin-left: 250px; /* Bằng đúng chiều rộng của .sidebar */
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .login-header {
            margin-bottom: 30px;
            text-align: center;
        }
        
        .login-header h1 {
            color: #1e4c78;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .login-header p {
            color: #666;
        }
        
        .login-form {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #444;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: #2c6cb0;
            outline: none;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            font-size: 16px;
            transition: background-color 0.3s;
            min-width: 30px;
            text-align: center;
        }
        
        .btn-primary {
            background-color: #2c6cb0;
            color: white;
            width: auto;
        }
        
        .btn-primary:hover {
            background-color: #1e4c78;
        }
        
        .register-link {
            margin-top: 20px;
            color: #666;
            text-align: center;
        }
        
        .register-link a {
            color: #2c6cb0;
            text-decoration: none;
            font-weight: 500;
        }
        
        .register-link a:hover {
            text-decoration: underline;
        }
        
        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        /* Các màn hình chính và con */
        #main-screen {
            display: none;
        }
        #register-screen {
            display: none;
        }

        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .logout-btn {
            background: none;
            border: none;
            color: #1e4c78;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .screen-header {
            background-color: #1e4c78;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 3px;
            margin-bottom: 15px;
        }
        
        .back-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .form-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 5px;
            margin-bottom: 20px;
        }
        
        .form-group-full {
            grid-column: 1 / -1;
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .form-buttons {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .btn-update {
            background-color: #28a745;
            color: white;
            display: none;
        }
        
        .btn-update:hover {
            background-color: #218838;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            font-size: 14px;
        }
        
        .data-table th, .data-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .data-table th {
            background-color: #f2f6fc;
            color: #1e4c78;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .data-table tr:hover {
            background-color: #f9f9f9;
        }
        
        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .btn-edit {
            background-color: #17a2b8;
            color: white;
        }
        
        .btn-delete {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-open {
            background-color: #ff9100;
            color: white;
        }

        .input-group {
            display: flex;
            gap: 5px;
        }
        
        .input-group select, .input-group input {
            flex: 1;
        }
        
        .btn-sm {
            padding: 5px;
            font-size: 12px;
            height: 30px;
            width: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background-color: white;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 5px;
            width: 400px;
            max-width: 90%;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
        }
        
        @media (max-width: 1024px) {
            .data-table {
                display: block;
                overflow-x: auto;
            }
        }
        
        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #ddd;
            }
            
            .form-container {
                grid-template-columns: 1fr;
            }
            
            .form-buttons {
                flex-direction: column;
            }
            
            .input-group {
                flex-direction: column;
            }
        }
        
        .search-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        
        .filter-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .filter-input:focus {
            outline: none;
            border-color: #2c6cb0;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .menu-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .menu-card i {
            font-size: 40px;
            color: #1e4c78;
            margin-bottom: 15px;
        }

        .menu-card h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .menu-card p {
            color: #666;
            font-size: 14px;
        }

        /* Styles mới cho trang tổng hợp */
        .tong-hop-container {
            padding: 20px;
        }

        .tong-hop-header {
            text-align: center;
            margin-bottom: 30px;
            color: #1e4c78;
        }

        .tong-hop-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .tong-hop-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .tong-hop-card h3 {
            color: #1e4c78;
            border-bottom: 2px solid #1e4c78;
            padding-bottom: 10px;
            margin-bottom: 15px;
            text-align: center;
        }

        .tong-hop-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .tong-hop-total {
            background-color: #1e4c78;
            color: white;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            margin-top: 20px;
        }

        /* Loading indicator */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div id="login-screen" class="content-section active">
            <div class="login-header">
                <h1>HỆ THỐNG QUẢN Lý CÔNG VĂN</h1>
                <p>Đăng nhập để tiếp tục</p>
            </div>
            
            <div class="login-form">
                <div class="form-group">
                    <label for="username">Tên đăng nhập</label>
                    <input type="text" id="username" placeholder="Nhập tên đăng nhập">
                    <div class="error-message" id="username-error"></div>
                </div>
                
                <div class="form-group">
                    <label for="password">Mật khẩu</label>
                    <input type="password" id="password" placeholder="Nhập mật khẩu">
                    <div class="error-message" id="password-error"></div>
                </div>
                
                <button class="btn btn-primary" id="login-btn">Đăng nhập</button>
                
                <div class="register-link">
                    Chưa có tài khoản?
                    <a href="#" id="show-register">Đăng ký ngay</a>
                </div>
            </div>
        </div>
        
        <div id="register-screen" class="content-section">
            <div class="login-header">
                <h1>ĐĂNG Ký TÀI KHOẢN</h1>
                <p>Tạo tài khoản mới để sử dụng hệ thống</p>
            </div>
            
            <div class="login-form">
                <div class="form-group">
                    <label for="reg-fullname">Họ và tên</label>
                    <input type="text" id="reg-fullname" placeholder="Nhập họ và tên">
                    <div class="error-message" id="reg-fullname-error"></div>
                </div>
                
                <div class="form-group">
                    <label for="reg-username">Tên đăng nhập</label>
                    <input type="text" id="reg-username" placeholder="Nhập tên đăng nhập">
                    <div class="error-message" id="reg-username-error"></div>
                </div>
                
                <div class="form-group">
                    <label for="reg-password">Mật khẩu</label>
                    <input type="password" id="reg-password" placeholder="Nhập mật khẩu">
                    <div class="error-message" id="reg-password-error"></div>
                </div>
                
                <div class="form-group">
                    <label for="reg-confirm">Xác nhận mật khẩu</label>
                    <input type="password" id="reg-confirm" placeholder="Nhập lại mật khẩu">
                    <div class="error-message" id="reg-confirm-error"></div>
                </div>
                
                <button class="btn btn-primary" id="register-btn">Đăng ký</button>
                
                <div class="register-link">
                    Đã có tài khoản?
                    <a href="#" id="show-login">Đăng nhập</a>
                </div>
            </div>
        </div>
    </div>

    <div class="main-layout">
        <div class="sidebar" id="sidebar">
            <div class="logo">
                <h2>HỆ THỐNG</h2>
                <p>QUẢN Lý CÔNG VĂN</p>
            </div>
            <div class="menu-item active" data-target="main-screen">
                <i class="fas fa-home"></i> Trang chủ
            </div>
            <div class="menu-item" data-target="cong-van-di-screen">
                <i class="fas fa-arrow-up"></i> Công văn đi
            </div>
            <div class="menu-item" data-target="cong-van-den-screen">
                <i class="fas fa-arrow-down"></i> Công văn đến
            </div>
            <div class="menu-item" data-target="tim-kiem-screen">
                <i class="fas fa-search"></i> Tra cứu
            </div>
            <div class="menu-item" data-target="tong-hop-screen">
                <i class="fas fa-chart-bar"></i> Tổng hợp
            </div>
        </div>

        <div class="content-container">
            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <p>Đang tải dữ liệu...</p>
            </div>

            <div id="main-screen" class="content-section active">
                <div class="main-header">
                    <h1>QUẢN Lý CÔNG Văn</h1>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="user-info">
                            <img src="https://ui-avatars.com/api/?name=User&background=random" alt="User">
                            <span id="user-display">Người dùng</span>
                        </div>
                        <button class="logout-btn" id="logout-btn">
                            <i class="fas fa-sign-out-alt"></i> Đăng xuất
                        </button>
                    </div>
                </div>
                
                <div class="tong-hop-container">
                    <div class="tong-hop-header">
                        <h2>TỔNG HỢP CÔNG VĂN ĐI - ĐẾN</h2>
                    </div>
                    
                    <div class="tong-hop-grid">
                        <div class="tong-hop-card">
                            <h3>CÔNG VĂN ĐI</h3>
                            <div id="tong-hop-di-content">
                                <!-- Nội dung sẽ được cập nhật bằng JavaScript -->
                            </div>
                        </div>
                        
                        <div class="tong-hop-card">
                            <h3>CÔNG VĂN ĐẾN</h3>
                            <div id="tong-hop-den-content">
                                <!-- Nội dung sẽ được cập nhật bằng JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="tong-hop-total">
                        <div>TỔNG CỘNG: <span id="tong-cong-di">0</span> công văn đi - <span id="tong-cong-den">0</span> công văn đến</div>
                    </div>
                </div>
            </div>
            
            <!-- Công văn đi -->
            <div id="cong-van-di-screen" class="content-section">
                <div class="screen-header">
                    <h2><i class="fas fa-arrow-up"></i> QUẢN Lý CÔNG VĂN ĐI</h2>
                    <button class="back-btn" data-target="main-screen">
                        <i class="fas fa-arrow-left"></i> Quay lại
                    </button>
                </div>
                
                <div class="form-container">
                    <div class="form-group">
                        <label for="nam">Năm</label>
                        <select id="nam">
                            <option value="">Chọn năm</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="so-vb">Số công văn</label>
                        <input type="text" id="so-vb" placeholder="Nhập số công văn">
                    </div>
                    
                    <div class="form-group">
                        <label for="ten-vb">Tên văn bản</label>
                        <input type="text" id="ten-vb" placeholder="Nhập tên văn bản">
                    </div>
                    
                    <div class="form-group">
                        <label for="ngay-ky">Ngày ký</label>
                        <input type="date" id="ngay-ky">
                    </div>
                    
                    <div class="form-group">
                        <label for="nguoi-ky">Người ký</label>
                        <input type="text" id="nguoi-ky" placeholder="Nhập tên người ký">
                    </div>
                    
                    <div class="form-group">
                        <label for="noi-ban-hanh">Nơi ban hành</label>
                        <input type="text" id="noi-ban-hanh" placeholder="Nhập nơi ban hành">
                    </div>
                    
                    <div class="form-group form-group-full">
                        <label for="noi-dung">Nội dung</label>
                        <textarea id="noi-dung" placeholder="Nhập nội dung công văn"></textarea>
                    </div>
                    
                    <div class="form-group form-group-full">
                        <label for="file-dinh-kem">File đính kèm</label>
                        <input type="file" id="file-dinh-kem">
                    </div>
                </div>
                
                <div class="form-buttons">
                    <button class="btn btn-secondary" id="reset-cvdi-btn">Làm mới</button>
                    <button class="btn btn-primary" id="save-cvdi-btn">Lưu công văn</button>
                    <button class="btn btn-update" id="update-cvdi-btn">Cập nhật</button>
                </div>
                
                <table class="data-table" id="cvdi-table">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Năm</th>
                            <th>Số VB</th>
                            <th>Tên VB</th>
                            <th>Ngày ký</th>
                            <th>Người ký</th>
                            <th>Nơi ban hành</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dữ liệu sẽ được thêm bằng JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <!-- Công văn đến -->
            <div id="cong-van-den-screen" class="content-section">
                <div class="screen-header">
                    <h2><i class="fas fa-arrow-down"></i> QUẢN Lý CÔNG VĂN ĐẾN</h2>
                    <button class="back-btn" data-target="main-screen">
                        <i class="fas fa-arrow-left"></i> Quay lại
                    </button>
                </div>
                
                <div class="form-container">
                    <div class="form-group">
                        <label for="nam-den">Năm</label>
                        <select id="nam-den">
                            <option value="">Chọn năm</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="so-den">Số đến</label>
                        <input type="text" id="so-den" placeholder="Nhập số đến">
                    </div>
                    
                    <div class="form-group">
                        <label for="nguoi-nhan">Người nhận</label>
                        <input type="text" id="nguoi-nhan" placeholder="Nhập tên người nhận">
                    </div>
                    
                    <div class="form-group">
                        <label for="ngay-nhan">Ngày nhận</label>
                        <input type="date" id="ngay-nhan">
                    </div>
                    
                    <div class="form-group">
                        <label for="so-cv-den">Số công văn</label>
                        <input type="text" id="so-cv-den" placeholder="Nhập số công văn">
                    </div>
                    
                    <div class="form-group">
                        <label for="ten-vb-den">Tên văn bản</label>
                        <input type="text" id="ten-vb-den" placeholder="Nhập tên VB đến">
                    </div>
                    
                    <div class="form-group">
                        <label for="ngay-ky-den">Ngày ký</label>
                        <input type="date" id="ngay-ky-den">
                    </div>
                    
                    <div class="form-group">
                        <label for="nguoi-ky-den">Người ký</label>
                        <input type="text" id="nguoi-ky-den" placeholder="Nhập tên người ký">
                    </div>
                    
                    <div class="form-group">
                        <label for="noi-ban-hanh-den">Nơi ban hành</label>
                        <input type="text" id="noi-ban-hanh-den" placeholder="Nhập nơi ban hành">
                    </div>
                    
                    <div class="form-group">
                        <label for="so-to">Số tờ</label>
                        <input type="number" id="so-to" placeholder="Nhập số tờ">
                    </div>
                    
                    <div class="form-group form-group-full">
                        <label for="noi-dung-den">Nội dung</label>
                        <textarea id="noi-dung-den" placeholder="Nhập nội dung công văn"></textarea>
                    </div>
                    
                    <div class="form-group form-group-full">
                        <label for="file-dinh-kem-den">File đính kèm</label>
                        <input type="file" id="file-dinh-kem-den">
                    </div>
                </div>
                
                <div class="form-buttons">
                    <button class="btn btn-secondary" id="reset-cvden-btn">Làm mới</button>
                    <button class="btn btn-primary" id="save-cvden-btn">Lưu công văn</button>
                    <button class="btn btn-update" id="update-cvden-btn">Cập nhật</button>
                </div>
                
                <table class="data-table" id="cvden-table">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Năm</th>
                            <th>Số đến</th>
                            <th>Người nhận</th>
                            <th>Ngày nhận</th>
                            <th>Số CV</th>
                            <th>Tên VB</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dữ liệu sẽ được thêm bằng JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Tra cứu -->
            <div id="tim-kiem-screen" class="content-section">
                <div class="screen-header">
                    <h2><i class="fas fa-search"></i> TRA CỨU CÔNG VĂN</h2>
                    <button class="back-btn" data-target="main-screen">
                        <i class="fas fa-arrow-left"></i> Quay lại
                    </button>
                </div>
                
                <div class="search-filters">
                    <div class="form-group">
                        <label>Loại công văn</label>
                        <select id="loai-cong-van">
                            <option value="cong-van-di">Công văn đi</option>
                            <option value="cong-van-den">Công văn đến</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-buttons">
                    <button class="btn btn-primary" id="show-all-btn">Hiển thị tất cả</button>
                </div>
                
                <table class="data-table" id="timkiem-cvdi-table">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Năm<br><input type="text" class="col-filter" data-col="1" placeholder=" Lọc năm"></th>
                            <th>Số VB<br><input type="text" class="col-filter" data-col="2" placeholder=" Lọc số VB"></th>
                            <th>Tên VB<br><input type="text" class="col-filter" data-col="3" placeholder=" Lọc tên VB"></th>
                            <th>Ngày ký<br><input type="text" class="col-filter" data-col="4" placeholder=" Lọc ngày ký"></th>
                            <th>Người ký<br><input type="text" class="col-filter" data-col="5" placeholder=" Lọc người ký"></th>
                            <th>Nơi ban hành<br><input type="text" class="col-filter" data-col="6" placeholder=" Lọc nơi ban hành"></th>
                            <th>Nội dung<br><input type="text" class="col-filter" data-col="7" placeholder=" Lọc nội dung"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dữ liệu sẽ được thêm bằng JavaScript -->
                    </tbody>
                </table>
                
                <table class="data-table" id="timkiem-cvden-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Năm<br><input type="text" class="col-filter" data-col="1" placeholder=" Lọc năm"></th>
                            <th>Số đến<br><input type="text" class="col-filter" data-col="2" placeholder=" Lọc số đến"></th>
                            <th>Người nhận<br><input type="text" class="col-filter" data-col="3" placeholder=" Lọc người nhận"></th>
                            <th>Ngày nhận<br><input type="text" class="col-filter" data-col="4" placeholder=" Lọc ngày nhận"></th>
                            <th>Số CV<br><input type="text" class="col-filter" data-col="5" placeholder=" Lọc số CV"></th>
                            <th>Tên VB<br><input type="text" class="col-filter" data-col="6" placeholder=" Lọc tên VB"></th>
                            <th>Nơi ban hành<br><input type="text" class="col-filter" data-col="7" placeholder=" Lọc nơi ban hành"></th>
                            <th>Nội dung<br><input type="text" class="col-filter" data-col="8" placeholder=" Lọc nội dung"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dữ liệu sẽ được thêm bằng JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Tổng hợp -->
            <div id="tong-hop-screen" class="content-section">
                <div class="screen-header">
                    <h2><i class="fas fa-chart-bar"></i> TỔNG HỢP BÁO CÁO</h2>
                    <button class="back-btn" data-target="main-screen">
                        <i class="fas fa-arrow-left"></i> Quay lại
                    </button>
                </div>
                
                <div class="tong-hop-container">
                    <div class="tong-hop-header">
                        <h2>TỔNG HỢP CÔNG VĂN ĐI - ĐẾN</h2>
                    </div>
                    
                    <div class="tong-hop-grid">
                        <div class="tong-hop-card">
                            <h3>CÔNG VĂN ĐI</h3>
                            <div id="tong-hop-di-content-report">
                                <!-- Nội dung sẽ được cập nhật bằng JavaScript -->
                            </div>
                        </div>
                        
                        <div class="tong-hop-card">
                            <h3>CÔNG VĂN ĐẾN</h3>
                            <div id="tong-hop-den-content-report">
                                <!-- Nội dung sẽ được cập nhật bằng JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="tong-hop-total">
                        <div>TỔNG CỘNG: <span id="tong-cong-di-report">0</span> công văn đi - <span id="tong-cong-den-report">0</span> công văn đến</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal xem file -->
    <div class="modal" id="file-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>XEM FILE ĐÍNH KÈM</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="file-modal-content">
                <!-- Nội dung file sẽ được hiển thị ở đây -->
            </div>
        </div>
    </div>

    <script>
        // ========== CẤU HÌNH FIREBASE ==========
        // Thay thế bằng cấu hình Firebase của bạn
        const firebaseConfig = {
            apiKey: "AIzaSyBWKTyXVK1y2dqxWUWprIxd5CCHMzSMc_o",
            authDomain: "quan-ly-cong-van-dede3.firebaseapp.com",
            databaseURL: "https://quan-ly-cong-van-dede3-default-rtdb.firebaseio.com",
            projectId: "quan-ly-cong-van-dede3",
            storageBucket: "quan-ly-cong-van-dede3.firebasestorage.app",
            messagingSenderId: "1080528314069",
            appId: "1:1080528314069:web:831f1b3c497ba082f80c5c",
        };

        // Khởi tạo Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // THÊM ĐOẠN NÀY: Đảm bảo kết nối realtime
        database.ref('.info/connected').on('value', (snapshot) => {
            if (snapshot.val() === true) {
                console.log('Đã kết nối với Firebase');
            } else {
                console.log('Mất kết nối với Firebase');
            }
        });

        // ========== KHAI BÁO BIẾN TOÀN CỤC ==========
        // Đăng nhập/đăng ký
        const loginContainer = document.querySelector('.login-container');
        const mainLayout = document.querySelector('.main-layout');
        const loginScreen = document.getElementById('login-screen');
        const registerScreen = document.getElementById('register-screen');
        const showRegisterBtn = document.getElementById('show-register');
        const showLoginBtn = document.getElementById('show-login');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userDisplay = document.getElementById('user-display');
        const loadingElement = document.getElementById('loading');
        
        // Công văn đi
        const namSelect = document.getElementById('nam');
        const tenVbSelect = document.getElementById('ten-vb');
        const nguoiKySelect = document.getElementById('nguoi-ky');
        const noiBanHanhSelect = document.getElementById('noi-ban-hanh');
        const saveCvdiBtn = document.getElementById('save-cvdi-btn');
        const updateCvdiBtn = document.getElementById('update-cvdi-btn');
        const resetCvdiBtn = document.getElementById('reset-cvdi-btn');
        let congVanDiData = [];
        let tempFileDataDi = null;
        let tempFileNameDi = '';
        let editIndexDi = -1;
        let editingCvDiId = null;
        
        // Công văn đến
        const namDenSelect = document.getElementById('nam-den');
        const tenVbDenSelect = document.getElementById('ten-vb-den');
        const nguoiKyDenSelect = document.getElementById('nguoi-ky-den');
        const nguoiNhanSelect = document.getElementById('nguoi-nhan');
        const noiBanHanhDenSelect = document.getElementById('noi-ban-hanh-den');
        const saveCvdenBtn = document.getElementById('save-cvden-btn');
        const updateCvdenBtn = document.getElementById('update-cvden-btn');
        const resetCvdenBtn = document.getElementById('reset-cvden-btn');
        let congVanDenData = [];
        let tempFileDataDen = null;
        let tempFileNameDen = '';
        let editIndexDen = -1;
        let editingCvDenId = null;
        
        // Tìm kiếm
        const loaiCongVanSelect = document.getElementById('loai-cong-van');
        const showAllBtn = document.getElementById('show-all-btn');
        
        // Modal
        const fileModal = document.getElementById('file-modal');
        const closeModalBtn = document.querySelector('.close-modal');

        // ========== HÀM HIỂN THỊ/ẨN LOADING ==========
        function showLoading() {
            loadingElement.style.display = 'block';
        }

        function hideLoading() {
            loadingElement.style.display = 'none';
        }

        // ========== FIREBASE AUTHENTICATION ==========
        // Hàm hiển thị màn hình đăng nhập
        function showLoginScreen() {
            loginScreen.style.display = "block";
            registerScreen.style.display = "none";
        }
        
        // Hàm hiển thị màn hình đăng ký
        function showRegisterScreen() {
            loginScreen.style.display = "none";
            registerScreen.style.display = "block";
        }
        
        // Hàm xử lý đăng nhập
        function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Kiểm tra thông tin đăng nhập
            if (!username) {
                document.getElementById('username-error').textContent = 'Vui lòng nhập tên đăng nhập';
                document.getElementById('username-error').style.display = 'block';
                return;
            } else {
                document.getElementById('username-error').style.display = 'none';
            }
            
            if (!password) {
                document.getElementById('password-error').textContent = 'Vui lòng nhập mật khẩu';
                document.getElementById('password-error').style.display = 'block';
                return;
            } else {
                document.getElementById('password-error').style.display = 'none';
            }
            
            showLoading();
            
            // Đăng nhập với Firebase Authentication
            auth.signInWithEmailAndPassword(username, password)
                .then((userCredential) => {
                    // Đăng nhập thành công
                    const user = userCredential.user;
                    loginContainer.style.display = 'none';
                    mainLayout.style.display = 'block';
                    userDisplay.textContent = user.email;
                    
                    // Tải dữ liệu từ Firebase
                    loadAllData();
                    hideLoading();
                })
                .catch((error) => {
                    hideLoading();
                    alert('Đăng nhập thất bại: ' + error.message);
                });
        }
        
        // Hàm xử lý đăng ký
        function handleRegister() {
            const fullname = document.getElementById('reg-fullname').value;
            const username = document.getElementById('reg-username').value;
            const password = document.getElementById('reg-password').value;
            const confirm = document.getElementById('reg-confirm').value;
            
            // Reset thông báo lỗi
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
            });
    
            // Kiểm tra thông tin đăng ký
            let isValid = true;
            
            if (!fullname) {
                document.getElementById('reg-fullname-error').textContent = 'Vui lòng nhập họ và tên';
                document.getElementById('reg-fullname-error').style.display = 'block';
                isValid = false;
            }
    
            if (!username) {
                document.getElementById('reg-username-error').textContent = 'Vui lòng nhập tên đăng nhập';
                document.getElementById('reg-username-error').style.display = 'block';
                isValid = false;
            } else if (!isValidEmail(username)) {
                document.getElementById('reg-username-error').textContent = 'Email không hợp lệ';
                document.getElementById('reg-username-error').style.display = 'block';
                isValid = false;
            }
    
            if (!password) {
                document.getElementById('reg-password-error').textContent = 'Vui lòng nhập mật khẩu';
                document.getElementById('reg-password-error').style.display = 'block';
                isValid = false;
            } else if (password.length < 6) {
                document.getElementById('reg-password-error').textContent = 'Mật khẩu phải có ít nhất 6 ký tự';
                document.getElementById('reg-password-error').style.display = 'block';
                isValid = false;
            }
    
            if (password !== confirm) {
                document.getElementById('reg-confirm-error').textContent = 'Mật khẩu xác nhận không khớp';
                document.getElementById('reg-confirm-error').style.display = 'block';
                isValid = false;
            }
            
            if (!isValid) return;
            
            showLoading();
    
            // Đăng ký với Firebase Authentication
            auth.createUserWithEmailAndPassword(username, password)
                .then((userCredential) => {
                    // Đăng ký thành công
                    const user = userCredential.user;
            
                    // Lưu thông tin người dùng vào Realtime Database
                    const userData = {
                        fullname: fullname,
                        email: username,
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    };
            
                    return database.ref('users/' + user.uid).set(userData)
                        .then(() => {
                            hideLoading();
                            alert('Đăng ký thành công! Vui lòng đăng nhập.');
                            showLoginScreen();
                    
                            // Reset form đăng ký
                            document.getElementById('reg-fullname').value = '';
                            document.getElementById('reg-username').value = '';
                            document.getElementById('reg-password').value = '';
                            document.getElementById('reg-confirm').value = '';
                        });
                })
                .catch((error) => {
                    hideLoading();
                    console.error('Lỗi đăng ký:', error);
                    
                    // Hiển thị thông báo lỗi chi tiết
                    let errorMessage = 'Đăng ký thất bại: ';
                    
                    switch (error.code) {
                        case 'auth/email-already-in-use':
                            errorMessage += 'Email đã được sử dụng.';
                            document.getElementById('reg-username-error').textContent = 'Email đã được sử dụng';
                            document.getElementById('reg-username-error').style.display = 'block';
                            break;
                        case 'auth/invalid-email':
                            errorMessage += 'Email không hợp lệ.';
                            document.getElementById('reg-username-error').textContent = 'Email không hợp lệ';
                            document.getElementById('reg-username-error').style.display = 'block';
                            break;
                        case 'auth/operation-not-allowed':
                            errorMessage += 'Phương thức đăng ký không được cho phép.';
                            break;
                        case 'auth/weak-password':
                            errorMessage += 'Mật khẩu quá yếu.';
                            document.getElementById('reg-password-error').textContent = 'Mật khẩu quá yếu';
                            document.getElementById('reg-password-error').style.display = 'block';
                            break;
                        default:
                            errorMessage += error.message;
                    }
    
                    alert(errorMessage);
                });
        }

        // Hàm kiểm tra email hợp lệ
        function isValidEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }
        
        // Kiểm tra trạng thái đăng nhập
        auth.onAuthStateChanged((user) => {
            if (user) {
                // Người dùng đã đăng nhập
                loginContainer.style.display = 'none';
                mainLayout.style.display = 'block';
                userDisplay.textContent = user.email;
                
                // Tải dữ liệu từ Firebase
                loadAllData();
            } else {
                // Người dùng đã đăng xuất
                loginContainer.style.display = 'flex';
                mainLayout.style.display = 'none';
                showLoginScreen();
            }
        });

        // Hàm xử lý đăng xuất
        function handleLogout() {
            showLoading();
            auth.signOut()
                .then(() => {
                    hideLoading();
                    alert('Đã đăng xuất thành công!');
                })
                .catch((error) => {
                    hideLoading();
                    alert('Lỗi khi đăng xuất: ' + error.message);
                });
        }

        // ========== FIREBASE REALTIME DATABASE ==========
        // Hàm lấy tất cả dữ liệu
        function loadAllData() {
            showLoading();

            console.log('Đang tải dữ liệu từ Firebase...');
            
            // Lấy dữ liệu công văn đi
            database.ref('congVanDi').once('value')
                .then((snapshot) => {
                    congVanDiData = [];
                    snapshot.forEach((childSnapshot) => {
                        const data = childSnapshot.val();
                        data.id = childSnapshot.key;
                        congVanDiData.push(data);
                    });
                    console.log('Đã tải', congVanDiData.length, 'công văn đi');
                    updateCvDiTable();
                    
                    // Lấy dữ liệu công văn đến
                    return database.ref('congVanDen').once('value');
                })
                .then((snapshot) => {
                    congVanDenData = [];
                    snapshot.forEach((childSnapshot) => {
                        const data = childSnapshot.val();
                        data.id = childSnapshot.key;
                        congVanDenData.push(data);
                    });
                    console.log('Đã tải', congVanDenData.length, 'công văn đến');
                    updateCvDenTable();
                    updateTongHop();
                    hideLoading();
                })
                .catch((error) => {
                    hideLoading();
                    alert('Lỗi khi tải dữ liệu: ' + error.message);
                });
                
            // Thiết lập listener để cập nhật realtime
            database.ref('congVanDi').on('value', (snapshot) => {
                congVanDiData = [];
                snapshot.forEach((childSnapshot) => {
                    const data = childSnapshot.val();
                    data.id = childSnapshot.key;
                    congVanDiData.push(data);
                });
                console.log('Realtime update - công văn đi:', congVanDiData.length);
                updateCvDiTable();
                updateTongHop();
            });
            
            database.ref('congVanDen').on('value', (snapshot) => {
                congVanDenData = [];
                snapshot.forEach((childSnapshot) => {
                    const data = childSnapshot.val();
                    data.id = childSnapshot.key;
                    congVanDenData.push(data);
                });
                console.log('Realtime update - công văn đến:', congVanDenData.length);
                updateCvDenTable();
                updateTongHop();
            });
        }
        
        // ========== CÔNG VĂN ĐI ==========
        // Tải năm vào select
        function loadYearsToSelect() {
            const currentYear = new Date().getFullYear();
            const yearSelects = document.querySelectorAll('select[id^="nam"]');
            
            yearSelects.forEach(select => {
                // Xóa các option hiện có (giữ option đầu tiên)
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // Thêm các năm từ 2020 đến năm hiện tại + 1
                for (let year = 2024; year <= 2035; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    select.appendChild(option);
                }
            });
        }
        
        // Tải tên văn bản vào select
        function loadTenVBsToSelect() {
            const tenVBs = ['Công văn', 'Tờ trình', 'Báo cáo', 'Quyết định', 'Kế hoạch', 'Thông báo'];
            const tenVbSelects = document.querySelectorAll('select[id^="ten-vb"]');
            
            tenVbSelects.forEach(select => {
                // Xóa các option hiện có (giữ option đầu tiên)
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // Thêm các tên văn bản
                tenVBs.forEach(tenVb => {
                    const option = document.createElement('option');
                    option.value = tenVb;
                    option.textContent = tenVb;
                    select.appendChild(option);
                });
            });
        }
        
        // Tải người ký vào select
        function loadNguoiKysToSelect() {
            const nguoiKys = ['Nguyễn Văn A', 'Trần Thị B', 'Lê Văn C', 'Phạm Thị D'];
            const nguoiKySelects = document.querySelectorAll('select[id^="nguoi-ky"]');
            
            nguoiKySelects.forEach(select => {
                // Xóa các option hiện có (giữ option đầu tiên)
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // Thêm các người ký
                nguoiKys.forEach(nguoiKy => {
                    const option = document.createElement('option');
                    option.value = nguoiKy;
                    option.textContent = nguoiKy;
                    select.appendChild(option);
                });
            });
        }
        
        // Tải nơi ban hành vào select
        function loadNoiBanHanhsToSelect() {
            const noiBanHanhs = ['Phòng Tổ chức', 'Phòng Kế hoạch', 'Phòng Tài chính', 'Ban Giám đốc'];
            const noiBanHanhSelects = document.querySelectorAll('select[id^="noi-ban-hanh"]');
            
            noiBanHanhSelects.forEach(select => {
                // Xóa các option hiện có (giữ option đầu tiên)
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // Thêm các nơi ban hành
                noiBanHanhs.forEach(noiBanHanh => {
                    const option = document.createElement('option');
                    option.value = noiBanHanh;
                    option.textContent = noiBanHanh;
                    select.appendChild(option);
                });
            });
        }
        
        // Tải người nhận vào select
        function loadNguoiNhansToSelect() {
            const nguoiNhans = ['Nguyễn Văn A', 'Trần Thị B', 'Lê Văn C', 'Phạm Thị D'];
            const nguoiNhanSelects = document.querySelectorAll('select[id^="nguoi-nhan"]');
            
            nguoiNhanSelects.forEach(select => {
                // Xóa các option hiện có (giữ option đầu tiên)
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // Thêm các người nhận
                nguoiNhans.forEach(nguoiNhan => {
                    const option = document.createElement('option');
                    option.value = nguoiNhan;
                    option.textContent = nguoiNhan;
                    select.appendChild(option);
                });
            });
        }
        
        // Cập nhật bảng công văn đi
        function updateCvDiTable() {
            const tableBody = document.querySelector('#cvdi-table tbody');
            tableBody.innerHTML = '';
            
            congVanDiData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.nam}</td>
                    <td>${item.soVb}</td>
                    <td>${item.tenVb}</td>
                    <td>${item.ngayKy || 'N/A'}</td>
                    <td>${item.nguoiKy || 'N/A'}</td>
                    <td>${item.noiBanHanh || 'N/A'}</td>
                    <td>
                        <button class="action-btn btn-edit" onclick="editCvDi('${item.id}')">Sửa</button>
                        <button class="action-btn btn-delete" onclick="deleteCvDi('${item.id}')">Xóa</button>
                        ${item.fileData ? `<button class="action-btn btn-open" onclick="openFileDi('${item.id}')">Xem file</button>` : ''}
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Reset form công văn đi
        function resetCvDiForm() {
            document.getElementById('so-vb').value = '';
            document.getElementById('noi-dung').value = '';
            document.getElementById('ngay-ky').value = '';
            namSelect.value = '';
            tenVbSelect.value = '';
            nguoiKySelect.value = '';
            noiBanHanhSelect.value = '';
            document.getElementById('file-dinh-kem').value = '';
            tempFileDataDi = null;
            tempFileNameDi = '';
            editingCvDiId = null;
            
            saveCvdiBtn.style.display = 'block';
            updateCvdiBtn.style.display = 'none';
        }
        
        // Sửa công văn đi
        function editCvDi(id) {
            const item = congVanDiData.find(item => item.id === id);
            
            if (!item) return;
            
            document.getElementById('nam').value = item.nam;
            document.getElementById('so-vb').value = item.soVb;
            document.getElementById('ten-vb').value = item.tenVb;
            document.getElementById('noi-dung').value = item.noiDung || '';
            document.getElementById('ngay-ky').value = item.ngayKy || '';
            document.getElementById('nguoi-ky').value = item.nguoiKy || '';
            document.getElementById('noi-ban-hanh').value = item.noiBanHanh || '';
            
            tempFileDataDi = item.fileData || null;
            tempFileNameDi = item.fileName || '';
            editingCvDiId = id;
            
            saveCvdiBtn.style.display = 'none';
            updateCvdiBtn.style.display = 'block';
        }
        
        // Xóa công văn đi
        function deleteCvDi(id) {
            if (confirm('Bạn có chắc chắn muốn xóa công văn này?')) {
                showLoading();
                database.ref('congVanDi/' + id).remove()
                    .then(() => {
                        hideLoading();
                        alert('Đã xóa công văn đi!');
                    })
                    .catch((error) => {
                        hideLoading();
                        alert('Lỗi khi xóa công văn: ' + error.message);
                    });
            }
        }
        
        // Xem file công văn đi
        function openFileDi(id) {
            const item = congVanDiData.find(item => item.id === id);
            if (item && item.fileData) {
                const fileModalContent = document.getElementById('file-modal-content');
                fileModalContent.innerHTML = `
                    <p><strong>Tên file:</strong> ${item.fileName}</p>
                    <iframe src="${item.fileData}" width="100%" height="500px" style="border: none;"></iframe>
                `;
                fileModal.style.display = 'flex';
            }
        }
        
        // ========== CÔNG VĂN ĐẾN ==========
        // Cập nhật bảng công văn đến
        function updateCvDenTable() {
            const tableBody = document.querySelector('#cvden-table tbody');
            tableBody.innerHTML = '';
            
            congVanDenData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.nam}</td>
                    <td>${item.soDen}</td>
                    <td>${item.nguoiNhan}</td>
                    <td>${item.ngayNhan || 'N/A'}</td>
                    <td>${item.soCvDen || 'N/A'}</td>
                    <td>${item.tenVbDen || 'N/A'}</td>
                    <td>
                        <button class="action-btn btn-edit" onclick="editCvDen('${item.id}')">Sửa</button>
                        <button class="action-btn btn-delete" onclick="deleteCvDen('${item.id}')">Xóa</button>
                        ${item.fileData ? `<button class="action-btn btn-open" onclick="openFileDen('${item.id}')">Xem file</button>` : ''}
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Reset form công văn đến
        function resetCvDenForm() {
            document.getElementById('so-den').value = '';
            document.getElementById('ngay-nhan').value = '';
            document.getElementById('so-cv-den').value = '';
            document.getElementById('noi-dung-den').value = '';
            document.getElementById('so-to').value = '';
            document.getElementById('ngay-ky-den').value = '';
            namDenSelect.value = '';
            tenVbDenSelect.value = '';
            nguoiKyDenSelect.value = '';
            nguoiNhanSelect.value = '';
            noiBanHanhDenSelect.value = '';
            document.getElementById('file-dinh-kem-den').value = '';
            tempFileDataDen = null;
            tempFileNameDen = '';
            editingCvDenId = null;
            
            saveCvdenBtn.style.display = 'block';
            updateCvdenBtn.style.display = 'none';
        }
        
        // Sửa công văn đến
        function editCvDen(id) {
            const item = congVanDenData.find(item => item.id === id);
            
            if (!item) return;
            
            document.getElementById('nam-den').value = item.nam;
            document.getElementById('so-den').value = item.soDen;
            document.getElementById('nguoi-nhan').value = item.nguoiNhan;
            document.getElementById('ngay-nhan').value = item.ngayNhan || '';
            document.getElementById('so-cv-den').value = item.soCvDen || '';
            document.getElementById('ten-vb-den').value = item.tenVbDen || '';
            document.getElementById('noi-dung-den').value = item.noiDungDen || '';
            document.getElementById('so-to').value = item.soTo || '';
            document.getElementById('ngay-ky-den').value = item.ngayKyDen || '';
            document.getElementById('nguoi-ky-den').value = item.nguoiKyDen || '';
            document.getElementById('noi-ban-hanh-den').value = item.noiBanHanhDen || '';
            
            tempFileDataDen = item.fileData || null;
            tempFileNameDen = item.fileNameDen || '';
            editingCvDenId = id;
            
            saveCvdenBtn.style.display = 'none';
            updateCvdenBtn.style.display = 'block';
        }
        
        // Xóa công văn đến
        function deleteCvDen(id) {
            if (confirm('Bạn có chắc chắn muốn xóa công văn này?')) {
                showLoading();
                database.ref('congVanDen/' + id).remove()
                    .then(() => {
                        hideLoading();
                        alert('Đã xóa công văn đến!');
                    })
                    .catch((error) => {
                        hideLoading();
                        alert('Lỗi khi xóa công văn: ' + error.message);
                    });
            }
        }
        
        // Xem file công văn đến
        function openFileDen(id) {
            const item = congVanDenData.find(item => item.id === id);
            if (item && item.fileData) {
                const fileModalContent = document.getElementById('file-modal-content');
                fileModalContent.innerHTML = `
                    <p><strong>Tên file:</strong> ${item.fileNameDen}</p>
                    <iframe src="${item.fileData}" width="100%" height="500px" style="border: none;"></iframe>
                `;
                fileModal.style.display = 'flex';
            }
        }
        
        // ========== TÌM KIẾM ==========
        // Tải dữ liệu tìm kiếm
        function loadSearchData() {
            const loaiCongVan = loaiCongVanSelect.value;
            
            if (loaiCongVan === 'cong-van-di') {
                document.getElementById('timkiem-cvdi-table').style.display = 'table';
                document.getElementById('timkiem-cvden-table').style.display = 'none';
                
                const tableBody = document.querySelector('#timkiem-cvdi-table tbody');
                tableBody.innerHTML = '';
                
                congVanDiData.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${item.nam}</td>
                        <td>${item.soVb}</td>
                        <td>${item.tenVb}</td>
                        <td>${item.ngayKy || 'N/A'}</td>
                        <td>${item.nguoiKy || 'N/A'}</td>
                        <td>${item.noiBanHanh || 'N/A'}</td>
                        <td>${item.noiDung || 'N/A'}</td>
                    `;
                    tableBody.appendChild(row);
                });
            } else {
                document.getElementById('timkiem-cvdi-table').style.display = 'none';
                document.getElementById('timkiem-cvden-table').style.display = 'table';
                
                const tableBody = document.querySelector('#timkiem-cvden-table tbody');
                tableBody.innerHTML = '';
                
                congVanDenData.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${item.nam}</td>
                        <td>${item.soDen}</td>
                        <td>${item.nguoiNhan}</td>
                        <td>${item.ngayNhan || 'N/A'}</td>
                        <td>${item.soCvDen || 'N/A'}</td>
                        <td>${item.tenVbDen || 'N/A'}</td>
                        <td>${item.noiBanHanhDen || 'N/A'}</td>
                        <td>${item.noiDungDen || 'N/A'}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }
        }
        
        // Lọc bảng
        function filterTable(input, tableId) {
            const filter = input.value.toUpperCase();
            const table = document.getElementById(tableId);
            const tr = table.getElementsByTagName('tr');
            
            for (let i = 1; i < tr.length; i++) {
                let td = tr[i].getElementsByTagName('td');
                let show = false;
                
                for (let j = 0; j < td.length; j++) {
                    if (td[j]) {
                        if (td[j].innerHTML.toUpperCase().indexOf(filter) > -1) {
                            show = true;
                            break;
                        }
                    }
                }
                
                tr[i].style.display = show ? '' : 'none';
            }
        }
        
        // ========== TỔNG HỢP ==========
        // Hàm cập nhật tổng hợp công văn
        function updateTongHop() {
            // Đếm số lượng công văn đi và đến
            const tongCongDi = congVanDiData.length;
            const tongCongDen = congVanDenData.length;
            
            // Cập nhật tổng cộng
            document.getElementById('tong-cong-di').textContent = tongCongDi;
            document.getElementById('tong-cong-den').textContent = tongCongDen;
            document.getElementById('tong-cong-di-report').textContent = tongCongDi;
            document.getElementById('tong-cong-den-report').textContent = tongCongDen;
            
            // Phân loại công văn đi theo tên văn bản
            const diTheoLoai = {};
            congVanDiData.forEach(cv => {
                if (diTheoLoai[cv.tenVb]) {
                    diTheoLoai[cv.tenVb]++;
                } else {
                    diTheoLoai[cv.tenVb] = 1;
                }
            });
            
            // Phân loại công văn đến theo tên văn bản
            const denTheoLoai = {};
            congVanDenData.forEach(cv => {
                if (denTheoLoai[cv.tenVbDen]) {
                    denTheoLoai[cv.tenVbDen]++;
                } else {
                    denTheoLoai[cv.tenVbDen] = 1;
                }
            });
            
            // Cập nhật nội dung công văn đi
            let diHtml = '';
            for (const [tenVb, soLuong] of Object.entries(diTheoLoai)) {
                diHtml += `<div class="tong-hop-item"><span>${tenVb}</span><span>${soLuong}</span></div>`;
            }
            document.getElementById('tong-hop-di-content').innerHTML = diHtml || '<p>Chưa có công văn đi</p>';
            document.getElementById('tong-hop-di-content-report').innerHTML = diHtml || '<p>Chưa có công văn đi</p>';
            
            // Cập nhật nội dung công văn đến
            let denHtml = '';
            for (const [tenVb, soLuong] of Object.entries(denTheoLoai)) {
                denHtml += `<div class="tong-hop-item"><span>${tenVb}</span><span>${soLuong}</span></div>`;
            }
            document.getElementById('tong-hop-den-content').innerHTML = denHtml || '<p>Chưa có công văn đến</p>';
            document.getElementById('tong-hop-den-content-report').innerHTML = denHtml || '<p>Chưa có công văn đến</p>';
        }
        
        // ========== KHỞI TẠO ỨNG DỤNG ==========
        function initApp() {
            // Tải dữ liệu vào các select
            loadYearsToSelect();
            loadTenVBsToSelect();
            loadNguoiKysToSelect();
            loadNoiBanHanhsToSelect();
            loadNguoiNhansToSelect();
            
            // Xử lý sự kiện cho menu
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function() {
                    const target = this.getAttribute('data-target');
                    
                    // Ẩn tất cả các màn hình
                    document.querySelectorAll('.content-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    
                    // Hiển thị màn hình được chọn
                    document.getElementById(target).classList.add('active');
                    
                    // Cập nhật menu active
                    document.querySelectorAll('.menu-item').forEach(menuItem => {
                        menuItem.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Nếu là màn hình tìm kiếm, tải dữ liệu
                    if (target === 'tim-kiem-screen') {
                        loadSearchData();
                    }
                    
                    // Nếu là màn hình tổng hợp, cập nhật dữ liệu
                    if (target === 'tong-hop-screen') {
                        updateTongHop();
                    }
                });
            });
            
            // Xử lý sự kiện cho nút quay lại
            document.querySelectorAll('.back-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const target = this.getAttribute('data-target');
                    
                    // Ẩn tất cả các màn hình
                    document.querySelectorAll('.content-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    
                    // Hiển thị màn hình chính
                    document.getElementById(target).classList.add('active');
                    
                    // Cập nhật menu active
                    document.querySelectorAll('.menu-item').forEach(menuItem => {
                        menuItem.classList.remove('active');
                        if (menuItem.getAttribute('data-target') === target) {
                            menuItem.classList.add('active');
                        }
                    });
                });
            });
            
            // Xử lý file đính kèm công văn đi
            document.getElementById('file-dinh-kem').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        tempFileDataDi = e.target.result;
                        tempFileNameDi = file.name;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Xử lý file đính kèm công văn đến
            document.getElementById('file-dinh-kem-den').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        tempFileDataDen = e.target.result;
                        tempFileNameDen = file.name;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Xử lý lưu công văn đi
            saveCvdiBtn.addEventListener('click', function() {
                const nam = namSelect.value;
                const soVb = document.getElementById('so-vb').value;
                const tenVb = tenVbSelect.value;
                const noiDung = document.getElementById('noi-dung').value;
                const ngayKy = document.getElementById('ngay-ky').value;
                const nguoiKy = nguoiKySelect.value;
                const noiBanHanh = noiBanHanhSelect.value;

                if (nam && soVb && tenVb) {
                    const newCongVan = { 
                        nam, 
                        soVb, 
                        tenVb, 
                        noiDung, 
                        fileData: tempFileDataDi,
                        fileName: tempFileNameDi,
                        ngayKy, 
                        nguoiKy, 
                        noiBanHanh,
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    showLoading();
                    
                    if (editingCvDiId) {
                        // Cập nhật công văn đi
                        database.ref('congVanDi/' + editingCvDiId).update(newCongVan)
                            .then(() => {
                                hideLoading();
                                resetCvDiForm();
                                alert('Đã cập nhật công văn đi!');
                            })
                            .catch((error) => {
                                hideLoading();
                                alert('Lỗi khi cập nhật công văn: ' + error.message);
                            });
                    } else {
                        // Thêm công văn đi mới
                        database.ref('congVanDi').push(newCongVan)
                            .then(() => {
                                hideLoading();
                                resetCvDiForm();
                                alert('Đã lưu công văn đi!');
                            })
                            .catch((error) => {
                                hideLoading();
                                alert('Lỗi khi lưu công văn: ' + error.message);
                            });
                    }
                } else {
                    alert('Vui lòng nhập đầy đủ thông tin bắt buộc.');
                }
            });
            
            // Xử lý reset công văn đi
            resetCvdiBtn.addEventListener('click', resetCvDiForm);
            
            // Xử lý lưu công văn đến
            saveCvdenBtn.addEventListener('click', function() {
                const nam = namDenSelect.value;
                const soDen = document.getElementById('so-den').value;
                const nguoiNhan = nguoiNhanSelect.value;
                const ngayNhan = document.getElementById('ngay-nhan').value;
                const soCvDen = document.getElementById('so-cv-den').value;
                const tenVbDen = tenVbDenSelect.value;
                const noiDungDen = document.getElementById('noi-dung-den').value;
                const soTo = document.getElementById('so-to').value;
                const ngayKyDen = document.getElementById('ngay-ky-den').value;
                const nguoiKyDen = nguoiKyDenSelect.value;
                const noiBanHanhDen = noiBanHanhDenSelect.value;

                if (nam && soDen && nguoiNhan) {
                    const newCongVan = { 
                        nam, 
                        soDen, 
                        nguoiNhan, 
                        ngayNhan, 
                        soCvDen, 
                        tenVbDen, 
                        noiDungDen, 
                        fileData: tempFileDataDen,
                        fileNameDen: tempFileNameDen,
                        soTo, 
                        ngayKyDen, 
                        nguoiKyDen, 
                        noiBanHanhDen,
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    showLoading();
                    
                    if (editingCvDenId) {
                        // Cập nhật công văn đến
                        database.ref('congVanDen/' + editingCvDenId).update(newCongVan)
                            .then(() => {
                                hideLoading();
                                resetCvDenForm();
                                alert('Đã cập nhật công văn đến!');
                            })
                            .catch((error) => {
                                hideLoading();
                                alert('Lỗi khi cập nhật công văn: ' + error.message);
                            });
                    } else {
                        // Thêm công văn đến mới
                        database.ref('congVanDen').push(newCongVan)
                            .then(() => {
                                hideLoading();
                                resetCvDenForm();
                                alert('Đã lưu công văn đến!');
                            })
                            .catch((error) => {
                                hideLoading();
                                alert('Lỗi khi lưu công văn: ' + error.message);
                            });
                    }
                } else {
                    alert('Vui lòng nhập đầy đủ thông tin bắt buộc.');
                }
            });
            
            // Xử lý reset công văn đến
            resetCvdenBtn.addEventListener('click', resetCvDenForm);
            
            // Xử lý tìm kiếm
            loaiCongVanSelect.addEventListener('change', function() {
                loadSearchData();
            });

            // Gán sự kiện cho nút đăng ký
            registerBtn.addEventListener('click', handleRegister);
            
            document.querySelectorAll('.filter-input').forEach(input => {
                input.addEventListener('keyup', function() {
                    const activeTableId = loaiCongVanSelect.value === 'cong-van-di' 
                        ? 'timkiem-cvdi-table' 
                        : 'timkiem-cvden-table';
                    filterTable(this, activeTableId);
                });
            });

            showAllBtn.addEventListener('click', function() {
                loadSearchData();
                document.querySelectorAll('.filter-input').forEach(input => input.value = '');
            });
            
            // Xử lý đóng modal
            closeModalBtn.addEventListener('click', function() {
                fileModal.style.display = 'none';
            });
            
            // Đóng modal khi click bên ngoài
            window.addEventListener('click', function(e) {
                if (e.target === fileModal) {
                    fileModal.style.display = 'none';
                }
            });
        }
        
        // ========== SỰ KIỆN ĐĂNG NHẬP/ĐĂNG KÝ ==========
        // Gán sự kiện cho các nút
        showRegisterBtn.addEventListener('click', showRegisterScreen);
        showLoginBtn.addEventListener('click', showLoginScreen);
        loginBtn.addEventListener('click', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        
        // ========== KHỞI CHẠY ỨNG DỤNG ==========
        initApp();

        // Cho phép sử dụng các hàm toàn cục từ HTML
        window.editCvDi = editCvDi;
        window.deleteCvDi = deleteCvDi;
        window.editCvDen = editCvDen;
        window.deleteCvDen = deleteCvDen;
        window.openFileDi = openFileDi;
        window.openFileDen = openFileDen;
    
        function filterByColumn(input) {
            const colIndex = parseInt(input.getAttribute("data-col"));
            const filter = input.value.toUpperCase();
            const table = input.closest("table");
            const tr = table.getElementsByTagName("tr");

            for (let i = 1; i < tr.length; i++) {
                let td = tr[i].getElementsByTagName("td")[colIndex];
                if (td) {
                    tr[i].style.display = td.innerHTML.toUpperCase().indexOf(filter) > -1 ? "" : "none";
                }
            }
        }

        document.addEventListener("DOMContentLoaded", function() {
            document.querySelectorAll('.col-filter').forEach(input => {
                input.addEventListener('keyup', function() {
                    filterByColumn(this);
                });
            });
        });
    </script>
</body>

</html>
