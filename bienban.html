<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biên bản kết quả kiểm phiếu</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Times New Roman', serif; }
        body { background-color: #f5f7fa; color: #000; font-size: 14px; line-height: 1.6; }
        
        /* Header styles */
        header {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 1000;
            height: 60px;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header-title {
            font-size: 20px;
            font-weight: bold;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.3s ease;
        }
        
        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* Main content styles */
        .main-content { 
            padding: 20px; 
            max-width: 1200px;
            margin: 0 auto;
            margin-top: 80px;
        }
        
        .page-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            flex-wrap: wrap; 
            gap: 15px; 
        }
        
        .page-header h2 { 
            font-size: 20px; 
            color: #2a5298; 
        }
        
        .user-info { 
            display: flex; 
            align-items: center; 
            background: white; 
            padding: 8px 16px; 
            border-radius: 25px; 
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); 
            font-size: 13px; 
        }
        
        .user-info img { 
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            margin-right: 8px; 
        }

        .bien-ban-wrapper { 
            background: white; 
            padding: 40px; 
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1); 
            max-width: 850px; 
            margin: 20px auto; 
        }
        
        .bb-header-top { 
            display: flex; 
            justify-content: space-between; 
            font-weight: bold; 
        }
        
        .bb-title { 
            text-align: center; 
            margin: 20px 0; 
        }
        
        .bb-title h2 { 
            font-size: 16px; 
            font-weight: bold; 
            text-transform: uppercase; 
        }
        
        .bb-title p { 
            font-size: 14px; 
            font-weight: bold; 
        }
        
        .bb-body p { 
            margin-bottom: 10px; 
        }
        
        .bb-list { 
            padding-left: 20px; 
        }
        
        .bb-results-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 15px 0; 
        }
        
        .bb-results-table td { 
            padding: 5px; 
        }
        
        .bb-signature { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            margin-top: 50px; 
            text-align: center; 
            gap: 20px; 
        }
        
        .bb-signature .sig-block { 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
        }
        
        .bb-signature p { 
            font-weight: bold; 
        }
        
        .bb-signature .sig-role { 
            font-style: italic; 
            font-weight: normal; 
        }
        
        .bb-footer { 
            margin-top: 50px; 
        }
        
        .action-buttons { 
            display: flex; 
            justify-content: center; 
            margin-bottom: 20px; 
            flex-wrap: wrap; 
            gap: 10px; 
        }
        
        .action-btn { 
            padding: 8px 16px; 
            background: #2a5298; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 13px; 
            transition: background 0.3s ease; 
        }
        
        .action-btn:hover { 
            background: #1e3c72; 
        }
        
        .btn-success { 
            background: #28a745; 
        }
        
        .btn-success:hover { 
            background: #218838; 
        }
        
        .loading { 
            text-align: center; 
            padding: 20px; 
            color: #666; 
            font-size: 13px; 
        }
        
        .placeholder { 
            color: #888; 
        }
        
        /* ========== Responsive cho tablet và điện thoại ========== */
        
        /* Màn hình nhỏ hơn laptop (tablet trở xuống) */
        @media (max-width: 992px) {
            .main-content {
                padding: 15px;
            }
            
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .page-header h2 {
                font-size: 18px;
                text-align: left;
            }
            
            .user-info {
                align-self: flex-end;
            }
            
            .bien-ban-wrapper {
                padding: 20px;
                margin: 10px auto;
                width: 100%;
            }
            
            .bb-signature {
                grid-template-columns: 1fr;
                gap: 30px;
            }
        }
        
        /* Màn hình điện thoại nhỏ (dưới 600px) */
        @media (max-width: 600px) {
            body {
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thông tin - Quản lý Phiếu bầu</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            font-size: 13px;
            line-height: 1.4;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            padding: 12px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header-title {
            font-size: 18px;
            font-weight: 600;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            margin-top: 80px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .page-header h2 {
            font-size: 20px;
            color: #2a5298;
        }

        .user-info {
            display: flex;
            align-items: center;
            background: white;
            padding: 8px 16px;
            border-radius: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            font-size: 13px;
        }

        .user-info img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 8px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
            gap: 5px;
        }

        .tab {
            padding: 10px 16px;
            cursor: pointer;
            background: #f5f7fa;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 6px 6px 0 0;
            transition: all 0.3s ease;
            font-size: 13px;
            white-space: nowrap;
        }

        .tab.active {
            background: white;
            border-color: #2a5298;
            color: #2a5298;
            font-weight: 600;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 0 6px 6px 6px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #2a5298;
            font-size: 13px;
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            border-color: #2a5298;
            outline: none;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .readonly-field {
            background-color: #f8f9fa;
            color: #666;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 13px;
        }

        table th, table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        table th {
            background-color: #f8f9fa;
            color: #2a5298;
            font-weight: 600;
            font-size: 13px;
        }

        .btn {
            padding: 8px 16px;
            background: #2a5298;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.3s ease;
        }

        .btn:hover {
            background: #1e3c72;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid #2a5298;
            color: #2a5298;
            padding: 7px 15px;
        }

        .btn-outline:hover {
            background: #2a5298;
            color: white;
        }

        .back-btn {
            background-color: #7f8c8d;
        }
        
        .back-btn:hover {
            background-color: #95a5a6;
        }
        
        .logout-btn {
            background-color: #e74c3c;
        }
        
        .logout-btn:hover {
            background-color: #c0392b;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 13px;
        }

        /* Compact form styles */
        .compact-form .form-group {
            margin-bottom: 12px;
        }

        .compact-form .form-control {
            padding: 7px 10px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                padding: 0 15px;
            }
            
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .user-info {
                align-self: flex-end;
            }
            
            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
            }
            
            .tab {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            .tab-content {
                padding: 15px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            table {
                font-size: 12px;
            }
            
            table th, table td {
                padding: 8px 10px;
            }
            
            .btn {
                padding: 7px 12px;
                font-size: 12px;
            }

            .form-row {
                flex-direction: column;
                gap: 10px;
            }

            h2 {
                font-size: 1.1rem;
                text-align: center;
            }
            
            .tab-content {
                padding: 12px;
            }
        }

        @media (max-width: 480px) {
            body {
                font-size: 12px;
            }
            
            }
            
            .btn {
                padding: 6px 10px;
                font-size: 12px;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
@media (max-width: 768px) {
            .main-content {
                padding: 0 15px;
            }
            
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .user-info {
                align-self: flex-end;
            }
            
            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
            }
            
            .tab {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            .tab-content {
                padding: 15px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            table {
                font-size: 12px;
            }
            
            table th, table td {
                padding: 8px 10px;
            }
            
            .btn {
                padding: 7px 12px;
                font-size: 12px;
            }

            .form-row {
                flex-direction: column;
                gap: 10px;
            }

            h2 {
                font-size: 1.1rem;
                text-align: center;
            }
            
            .tab-content {
                padding: 12px;
            }
        }

        @media (max-width: 480px) {
            body {
                font-size: 12px;
            }
            
            .main-content {
                padding: 0 10px;
            }
            
            .page-header h2 {
                font-size: 18px;
            }
            
            .user-info {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            .user-info img {
                width: 28px;
                height: 28px;
            }
            
            .tab-content {
                padding: 12px;
            }
            
            .form-control {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .btn {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .header-title {
                font-size: 0.9rem;
                max-width: 40%;
            }
            
            .btn {
                padding: 0.4rem 0.7rem;
                font-size: 0.75rem;
            }
            
            .header-buttons {
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="header-title">HỆ THỐNG BẦU CỬ</div>
            <div class="header-buttons">
                <button onclick="window.location.href='dashboard.html'" class="btn back-btn">Quay lại</button>
                <button id="logoutBtn" class="btn logout-btn">Đăng xuất</button>
            </div>
        </div>
    </header>
    <div class="main-content">
        <div class="page-header">
            <h2>Biên bản kết quả kiểm phiếu</h2>
            <div class="user-info">
                <img src="https://ui-avatars.com/api/?name=Admin&background=2a5298&color=fff" alt="User">
                <span id="userName">Quản trị viên</span>
            </div>
        </div>

        <div id="loading" class="loading">Đang tải dữ liệu...</div>

        <div id="mainContent" style="display: none;">
            <div class="action-buttons">
                <button id="btnInBienBan" class="action-btn">In biên bản</button>
                <button id="btnTaiXuongWord" class="action-btn btn-success">Tải xuống Word (.doc)</button>
            </div>

            <div id="bienBanContent" class="bien-ban-wrapper">
                <div class="bb-header-top">
                    <p>Tỉnh/Thành phố: <span id="tinhThanhBb" class="placeholder">...</span><br>Xã/Phường/Thị trấn: <span id="phuongXaBb" class="placeholder">...</span></p>
                    <p style="text-align: center;">CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM<br>Độc lập - Tự do - Hạnh phúc</p>
                </div>

                <div class="bb-title">
                    <h2>Biên bản kết quả kiểm phiếu</h2>
                    <p>BẦU CỬ ĐẠI BIỂU HỘI ĐỒNG NHÂN DÂN <span id="capBauCuBb" class="placeholder">...</span><br>KHÓA <span id="khoaBb" class="placeholder">...</span> NHIỆM KỲ <span id="nhiemKyBb" class="placeholder">...</span></p>
                    <h3>CỦA TỔ BẦU CỬ</h3>
                </div>

                <div class="bb-body">
                    <p>Khu vực bỏ phiếu số: <span id="khuVucBoPhieuBb" class="placeholder">...</span> Xã/Phường/Thị trấn: <span id="phuongXaBb2" class="placeholder">...</span></p>
                    <p>Đơn vị bầu cử đại biểu Hội đồng nhân dân <span id="capBauCuBb2" class="placeholder">...</span> số: <span id="donViBauCuBb" class="placeholder">...</span></p>
                    <p>Gồm có: <span id="gomCoBb" class="placeholder">...</span></p>
                    <p>Hồi ........ giờ ......... phút, ngày ...... tháng ....... năm ......, Tổ bầu cử gồm có:</p>
                    <div id="danhSachKiemPhieuBb" class="bb-list">
                        <p class="placeholder">Đang tải danh sách...</p>
                    </div>
                    <p>Đã họp tại phòng bầu cử của khu vực bỏ phiếu số: <span id="khuVucBoPhieuBb2" class="placeholder">...</span> xã/phường/thị trấn: <span id="phuongXaBb3" class="placeholder">...</span> thuộc đơn vị bầu cử đại biểu Hội đồng nhân dân số: <span id="donViBauCuBb2" class="placeholder">...</span> để tiến hành việc kiểm phiếu bầu cử đại biểu Hội đồng nhân dân <span id="capBauCuBb3" class="placeholder">...</span> khóa <span id="khoaBb2" class="placeholder">...</span> nhiệm kỳ <span id="nhiemKyBb2" class="placeholder">...</span>.</p>
                    <p>Đúng ........ giờ ....... phút, ngày .... tháng .... năm ...., đại diện Tổ bầu cử kiểm tra hòm phiếu với sự chứng kiến của hai cử tri là:</p>
                    <div id="danhSachChungKienBb1" class="bb-list">
                        <p class="placeholder">Đang tải danh sách...</p>
                    </div>
                    <p>Sau đó, Tổ bầu cử đã khoá và niêm phong hòm phiếu lại, mời cử tri bắt đầu bầu cử.</p>
                    <p>Đúng ....... giờ ...... phút ngày ...... tháng ...... năm ...., Tổ trưởng Tổ bầu cử tuyên bố kết thúc cuộc bầu cử và tiến hành kiểm phiếu ngay tại phòng bầu cử.</p>
                    <p>Trước khi mở hòm phiếu, Tổ trưởng Tổ bầu cử đã mời hai cử tri biết chữ, không phải là người ứng cử chứng kiến việc kiểm phiếu gồm:</p>
                     <div id="danhSachChungKienBb2" class="bb-list">
                        <p class="placeholder">Đang tải danh sách...</p>
                    </div>
                    <p>Trước khi mở hòm phiếu, Tổ bầu cử đã tiến hành kiểm kê và lập biên bản về việc sử dụng phiếu bầu cử đại biểu Hội đồng nhân dân các cấp.</p>
                    <p><strong>Kết quả cuộc bầu cử như sau:</strong></p>
                    <table class="bb-results-table">
                        <tr><td>- Số đại biểu Hội đồng nhân dân ấn định cho đơn vị bầu cử:</td><td><span id="soNguoiDuocBauBb" class="placeholder">0</span> người</td></tr>
                        <tr><td>- Số người ứng cử:</td><td><span id="soNguoiUngCuBb" class="placeholder">0</span> người</td></tr>
                        <tr><td>- Tổng số cử tri của khu vực bỏ phiếu:</td><td><span id="tongSoCuTriBb" class="placeholder">0</span> người</td></tr>
                        <tr><td>- Số cử tri đã tham gia bỏ phiếu:</td><td><span id="thamGiaBoPhieuBb" class="placeholder">0</span> người</td></tr>
                        <tr><td>- Tỷ lệ cử tri đã tham gia bầu phiếu so với tổng số cử tri:</td><td><span id="phanTramThamGiaBb" class="placeholder">0%</span></td></tr>
                        <tr><td>- Số phiếu phát ra:</td><td><span id="soPhieuPhatRaBb" class="placeholder">0</span></td></tr>
                        <tr><td>- Số phiếu thu vào:</td><td><span id="soPhieuThuVaoBb" class="placeholder">0</span></td></tr>
                        <tr><td>- Số phiếu hợp lệ:</td><td><span id="soPhieuHopLeBb" class="placeholder">0</span> (Tỷ lệ: <span id="phanTramHopLeBb" class="placeholder">0%</span>)</td></tr>
                        <tr><td>- Số phiếu không hợp lệ:</td><td><span id="soPhieuKhongHopLeBb" class="placeholder">0</span> (Tỷ lệ: <span id="phanTramKhongHopLeBb" class="placeholder">0%</span>)</td></tr>
                    </table>
                    <p><strong>- Số phiếu bầu cho mỗi người ứng cử:</strong></p>
                    <div id="ketQuaUngVienContainer" class="bb-list">
                       <p class="placeholder">Đang tải kết quả...</p>
                    </div>
                    <p>Trong ngày bầu cử và thời gian kiểm phiếu, đã xảy ra sự việc hoặc khiếu nại, tố cáo sau đây: ....................................................................................................................................................</p>
                    <p>Những vấn đề hoặc khiếu nại, tố cáo chưa được giải quyết và kiến nghị: ....................................................................................................................................................</p>
                    <p>Biên bản này được lập thành 03 bản và được gửi đến Ban bầu cử đại biểu Hội đồng nhân dân <span id="capBauCuBb4" class="placeholder">...</span> và Ủy ban nhân dân, Ban thường trực Ủy ban Mặt trận Tổ quốc Việt Nam cấp xã.</p>
                </div>

                <div class="bb-signature">
                    <div class="sig-block">
                        <p>CỬ TRI THỨ NHẤT CHỨNG KIẾN</p>
                        <p class="sig-role">(Ký, ghi rõ họ tên)</p>
                    </div>
                     <div class="sig-block">
                        <p>TM. TỔ BẦU CỬ</p>
                        <p>TỔ TRƯỞNG</p>
                        <p class="sig-role">(Ký tên và đóng dấu)</p>
                    </div>
                     <div class="sig-block">
                        <p>CỬ TRI THỨ HAI CHỨNG KIẾN</p>
                        <p class="sig-role">(Ký, ghi rõ họ tên)</p>
                    </div>
                     <div class="sig-block">
                        <p>THƯ KÝ TỔ BẦU CỬ</p>
                         <p class="sig-role">(Ký, ghi rõ họ tên)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyAt-OooTscmthbJXNcvy80RgPDA9T46-0w", 
            authDomain: "kiemphieu-45823.firebaseapp.com", 
            databaseURL: "https://kiemphieu-45823-default-rtdb.asia-southeast1.firebasedatabase.app", 
            projectId: "kiemphieu-45823", 
            storageBucket: "kiemphieu-45823.firebasestorage.app", 
            messagingSenderId: "908329514571", 
            appId: "1:908329514571:web:16b43df5b795e4de06bfce" 
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        let currentUser = null;

        function getUserPath(path = '') {
            if (!currentUser || !currentUser.uid) throw new Error('User not authenticated');
            return `users/${currentUser.uid}${path ? '/' + path : ''}`;
        }
        
        function fillText(id, value, defaultValue = '...') {
             const elements = document.querySelectorAll(`#${id}`);
             elements.forEach(el => el.textContent = value || defaultValue);
        }

        async function loadBienBanData() {
            try {
                const [donViSnap, kiemPhieuDataSnap, dsKiemPhieuSnap, dsChungKienSnap, ungCuSnap, candidateResultsSnap] = await Promise.all([
                    db.ref(getUserPath('donVi')).once('value'),
                    db.ref(getUserPath('kiemPhieuData')).once('value'),
                    db.ref(getUserPath('kiemPhieu')).once('value'),
                    db.ref(getUserPath('chungKien')).once('value'),
                    db.ref(getUserPath('ungCu')).once('value'),
                    db.ref(getUserPath('candidateResults')).once('value')
                ]);

                // Process "donVi" data
                if (donViSnap.exists()) {
                    const data = donViSnap.val();
                    fillText('tinhThanhBb', data.tinhThanh);
                    fillText('phuongXaBb', data.phuongXa);
                    fillText('phuongXaBb2', data.phuongXa);
                    fillText('phuongXaBb3', data.phuongXa);
                    fillText('khoaBb', data.khoa);
                    fillText('khoaBb2', data.khoa);
                    fillText('nhiemKyBb', data.nhiemKy);
                    fillText('nhiemKyBb2', data.nhiemKy);
                    fillText('khuVucBoPhieuBb', data.khuVucBoPhieu);
                    fillText('khuVucBoPhieuBb2', data.khuVucBoPhieu);
                    fillText('donViBauCuBb', data.donViBauCu);
                    fillText('donViBauCuBb2', data.donViBauCu);
                    fillText('gomCoBb', data.gomCo);
                    fillText('soNguoiUngCuBb', data.soNguoiUngCu, 0);
                    fillText('soNguoiDuocBauBb', data.soNguoiDuocBau, 0);

                    const capText = data.bauCuCap ? { 'quoc_hoi': 'Quốc hội', 'thanh_pho': 'Thành phố', 'phuong': 'Phường' }[data.bauCuCap] || data.bauCuCap : '...';
                    fillText('capBauCuBb', capText);
                    fillText('capBauCuBb2', capText);
                    fillText('capBauCuBb3', capText);
                    fillText('capBauCuBb4', capText);
                }

                // Process "kiemPhieuData"
                let tongPhieuThuVao = 0;
                let soPhieuHopLe = 0; // Defaulting to total votes
                if (kiemPhieuDataSnap.exists()) {
                    const data = kiemPhieuDataSnap.val();
                    tongPhieuThuVao = parseInt(data.soPhieuThuVao) || 0;
                    soPhieuHopLe = tongPhieuThuVao; // Assuming all votes are valid for now
                    
                    fillText('tongSoCuTriBb', data.tongSoCuTri, 0);
                    fillText('thamGiaBoPhieuBb', data.thamGiaBoPhieu, 0);
                    fillText('phanTramThamGiaBb', data.phanTramThamGia, '0%');
                    fillText('soPhieuPhatRaBb', data.soPhieuPhatRa, 0);
                    fillText('soPhieuThuVaoBb', data.soPhieuThuVao, 0);
                    fillText('soPhieuHopLeBb', soPhieuHopLe, 0);
                    fillText('soPhieuKhongHopLeBb', 0); // Placeholder
                    
                    const phanTramHopLe = tongPhieuThuVao > 0 ? '100%' : '0%'; // Simplified
                    fillText('phanTramHopLeBb', phanTramHopLe);
                    fillText('phanTramKhongHopLeBb', '0%'); // Simplified
                }

                // Process list of "kiemPhieu"
                const dsKiemPhieuDiv = document.getElementById('danhSachKiemPhieuBb');
                dsKiemPhieuDiv.innerHTML = '';
                if (dsKiemPhieuSnap.exists()) {
                    let stt = 1;
                    dsKiemPhieuSnap.forEach(child => {
                        const data = child.val();
                        dsKiemPhieuDiv.innerHTML += `<p>${stt}. Ông/Bà ${data.hoTen || ''} - ${data.chucVu || 'Ủy viên'}</p>`;
                        stt++;
                    });
                } else { dsKiemPhieuDiv.innerHTML = '<p class="placeholder">Không có dữ liệu người kiểm phiếu.</p>'; }

                // Process list of "chungKien" for both sections
                const dsChungKienDiv1 = document.getElementById('danhSachChungKienBb1');
                const dsChungKienDiv2 = document.getElementById('danhSachChungKienBb2');
                dsChungKienDiv1.innerHTML = '';
                dsChungKienDiv2.innerHTML = '';
                 if (dsChungKienSnap.exists()) {
                    let stt = 1;
                    let htmlContent = '';
                    dsChungKienSnap.forEach(child => {
                        const data = child.val();
                        htmlContent += `<p>${stt}. Ông/Bà: ${data.hoTen || ''} - Nơi ở hiện nay: ${data.diaChi || ''}</p>`;
                        stt++;
                    });
                    dsChungKienDiv1.innerHTML = htmlContent;
                    dsChungKienDiv2.innerHTML = htmlContent;
                } else { 
                    const noDataMsg = '<p class="placeholder">Không có dữ liệu người chứng kiến.</p>';
                    dsChungKienDiv1.innerHTML = noDataMsg;
                    dsChungKienDiv2.innerHTML = noDataMsg;
                }
                
                // Process candidate results
                const ketQuaUngVienContainer = document.getElementById('ketQuaUngVienContainer');
                ketQuaUngVienContainer.innerHTML = '';
                const ungCuData = ungCuSnap.exists() ? ungCuSnap.val() : {};
                const candidateResultsData = candidateResultsSnap.exists() ? candidateResultsSnap.val() : {};
                
                let resultsHtml = '';
                Object.keys(ungCuData).forEach(key => {
                    const hoTen = ungCuData[key].hoTen;
                    const result = candidateResultsData[key] || { soPhieu: 0 };
                    resultsHtml += `<p>Ông/Bà ${hoTen} được ${result.votes} phiếu / ${soPhieuHopLe} phiếu hợp lệ</p>`;
                });
                ketQuaUngVienContainer.innerHTML = resultsHtml || '<p class="placeholder">Chưa có kết quả.</p>';

            } catch (error) {
                console.error('Error loading data:', error);
                alert('Lỗi tải dữ liệu: ' + error.message);
            }
        }
        
        function exportToWord() {
            const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Biên bản</title></head><body>";
            const footer = "</body></html>";
            const sourceHTML = header + document.getElementById('bienBanContent').innerHTML + footer;
            
            const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
            const fileDownload = document.createElement("a");
            document.body.appendChild(fileDownload);
            fileDownload.href = source;
            const khuVucSo = document.getElementById('khuVucBoPhieuBb').textContent || 'X';
            fileDownload.download = `bien_ban_khu_vuc_so_${khuVucSo}.doc`;
            fileDownload.click();
            document.body.removeChild(fileDownload);
        }

        document.getElementById('btnInBienBan').addEventListener('click', () => window.print());
        document.getElementById('btnTaiXuongWord').addEventListener('click', exportToWord);

        auth.onAuthStateChanged(async (user) => {
            const loadingElement = document.getElementById('loading');
            const mainContentElement = document.getElementById('mainContent');
            if (user) {
                currentUser = user;
                document.getElementById('userName').textContent = user.email || 'Quản trị viên';
                await loadBienBanData();
                loadingElement.style.display = 'none';
                mainContentElement.style.display = 'block';
            } else {
                loadingElement.innerHTML = 'Chưa đăng nhập. Đang chuyển hướng...';
                setTimeout(() => { window.location.href = 'index.html'; }, 2000);
            }
        });
        
        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm('Bạn có chắc muốn đăng xuất?')) {
                auth.signOut().then(() => { window.location.href = 'index.html'; });
            }
        });
    </script>
</body>
</html>
